<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlInput = document.getElementById('urlInput');
        const bypassBtn = document.getElementById('bypassBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const success = document.getElementById('success');
        const resultContainer = document.getElementById('resultContainer');
        const resultUrl = document.getElementById('resultUrl');
        const resultText = document.getElementById('resultText');
        const copyBtn = document.getElementById('copyBtn');
        const redirectBtn = document.getElementById('redirectBtn');
        
        const urlParams = new URLSearchParams(window.location.search);
        const urlParam = urlParams.get('url');
        
        if (urlParam) {
            urlInput.value = decodeURIComponent(urlParam);
            setTimeout(() => {
                bypassBtn.click();
            }, 100);
        }
        
        bypassBtn.addEventListener('click', async function() {
            const url = urlInput.value.trim();
            
            if (!url) {
                showError('Please enter a URL');
                return;
            }
            
            try {
                new URL(url);
                if (!url.startsWith('http')) {
                    throw new Error('Invalid protocol');
                }
            } catch (e) {
                showError('Please enter a valid URL starting with http:// or https://');
                return;
            }
            
            loading.style.display = 'block';
            error.style.display = 'none';
            success.style.display = 'none';
            resultContainer.style.display = 'none';
            bypassBtn.disabled = true;
            bypassBtn.innerHTML = '<span>Processing...</span>';
            
            try {
                const apiUrl = `https://afklol-api.vercel.app/bypass?url=${encodeURIComponent(url)}`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.text();
                
                if (!data || data.trim() === '') {
                    throw new Error('Empty response from API');
                }
                
                let result = data;
                let processTime = '';
                
                try {
                    const jsonData = JSON.parse(data);
                    if (jsonData.result) {
                        result = jsonData.result;
                    }
                    if (jsonData.time) {
                        processTime = ` (${jsonData.time}s)`;
                    }
                } catch (e) {
                }
                
                displayResult(result);
                showSuccess(`URL processed successfully!${processTime}`);
                
            } catch (err) {
                console.error('Bypass error:', err);
                showError(`Failed to bypass URL: ${err.message}`);
            } finally {
                loading.style.display = 'none';
                bypassBtn.disabled = false;
                bypassBtn.innerHTML = '<span>Bypass</span>';
            }
        });
        
        function displayResult(result) {
            const cleanResult = result.trim();
            
            try {
                const testUrl = new URL(cleanResult);
                resultUrl.href = cleanResult;
                resultUrl.textContent = cleanResult;
                resultUrl.style.display = 'block';
                resultText.style.display = 'none';
                redirectBtn.style.display = 'block';
            } catch (e) {
                resultUrl.style.display = 'none';
                resultText.textContent = cleanResult;
                resultText.style.display = 'block';
                redirectBtn.style.display = 'none';
            }
            
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            success.style.display = 'none';
            resultContainer.style.display = 'none';
        }
        
        function showSuccess(message) {
            success.textContent = message;
            success.style.display = 'block';
            error.style.display = 'none';
        }
        
        copyBtn.addEventListener('click', function() {
            const textToCopy = resultUrl.style.display !== 'none' ? resultUrl.href : resultText.textContent;
            
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<span>Copied!</span>';
                    copyBtn.style.background = 'var(--success)';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.style.background = '';
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    showError('Failed to copy to clipboard');
                });
        });
        
        redirectBtn.addEventListener('click', function() {
            if (resultUrl.href) {
                window.location.href = resultUrl.href;
            }
        });
        
        urlInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                bypassBtn.click();
            }
        });
        
        urlInput.focus();
    });
</script>
